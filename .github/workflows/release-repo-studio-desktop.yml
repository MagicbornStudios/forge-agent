name: Release RepoStudio Desktop

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init required submodule
        run: |
          git submodule sync -- vendor/repo-studio-extensions
          git submodule update --init --depth 1 vendor/repo-studio-extensions

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version from packageManager in package.json

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Verify packageManager pin
        shell: bash
        run: |
          node -e "const cp=require('node:child_process');const fs=require('node:fs');const pkg=JSON.parse(fs.readFileSync('package.json','utf8'));const pm=String(pkg.packageManager||'');if(!pm.startsWith('pnpm@')){console.error('package.json packageManager must be pnpm@<version>');process.exit(1);}const expected=pm.slice('pnpm@'.length);const actual=cp.execSync('pnpm --version',{encoding:'utf8'}).trim();if(actual!==expected){console.error('pnpm version mismatch: expected '+expected+', got '+actual);process.exit(1);}console.log('pnpm version verified:',actual);"

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Seed CI Env Files
        run: |
          cp apps/repo-studio/.env.example apps/repo-studio/.env
          cp apps/platform/.env.example apps/platform/.env

      - name: Verify Codegen
        run: pnpm --filter @forge/repo-studio-app run codegen

      - name: Verify Generated App Spec
        run: pnpm --filter @forge/repo-studio-app run check:codegen

      - name: Build Repo Studio App (Linux smoke)
        continue-on-error: true
        run: pnpm --filter @forge/repo-studio-app build

      - name: Verify Extension Registry Health
        run: pnpm --filter @forge/repo-studio-app run extensions:registry:health

      - name: Build Platform App
        run: pnpm --filter @forge/platform build

      - name: Build Docs App (Linux smoke)
        continue-on-error: true
        shell: bash
        env:
          NEXT_TELEMETRY_DISABLED: '1'
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          set -o pipefail
          LOG_FILE="$(mktemp)"
          set +e
          pnpm --filter @forge/docs build 2>&1 | tee "$LOG_FILE"
          BUILD_EXIT="${PIPESTATUS[0]}"
          set -e
          if [ "$BUILD_EXIT" -ne 0 ]; then
            echo "::error title=docs-build::Build failed with exit code ${BUILD_EXIT}"
            while IFS= read -r line; do
              printf '::error title=docs-build-tail::%s\n' "$line"
            done < <(tail -n 80 "$LOG_FILE")
            exit "$BUILD_EXIT"
          fi

      - name: Run Hydration Doctor (Linux smoke)
        continue-on-error: true
        run: pnpm hydration:doctor

  package_windows:
    runs-on: windows-latest
    needs: verify
    timeout-minutes: 120
    env:
      REPOSTUDIO_WRITE_SMOKE_ARTIFACTS: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init required submodule
        run: |
          git submodule sync -- vendor/repo-studio-extensions
          git submodule update --init --depth 1 vendor/repo-studio-extensions

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        # version from packageManager in package.json

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Verify packageManager pin
        shell: pwsh
        run: |
          node -e "const cp=require('node:child_process');const fs=require('node:fs');const pkg=JSON.parse(fs.readFileSync('package.json','utf8'));const pm=String(pkg.packageManager||'');if(!pm.startsWith('pnpm@')){console.error('package.json packageManager must be pnpm@<version>');process.exit(1);}const expected=pm.slice('pnpm@'.length);const actual=cp.execSync('pnpm --version',{encoding:'utf8'}).trim();if(actual!==expected){console.error('pnpm version mismatch: expected '+expected+', got '+actual);process.exit(1);}console.log('pnpm version verified:',actual);"

      - name: Pin pnpm store to workspace drive
        shell: pwsh
        run: |
          pnpm config set store-dir "$env:GITHUB_WORKSPACE\\.pnpm-store"

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Seed Repo Studio CI Env
        run: Copy-Item apps/repo-studio/.env.example apps/repo-studio/.env

      - name: Build Strict Standalone Desktop Payload
        shell: pwsh
        timeout-minutes: 35
        run: |
          $logFile = Join-Path $env:RUNNER_TEMP 'desktop-standalone-build.log'
          $diagFile = 'packages/repo-studio/.desktop-build/failure-diagnostics.json'

          $command = "node packages/repo-studio/src/desktop/build.mjs --require-standalone"
          & cmd /d /s /c "$command 1>$logFile 2>&1"
          $standaloneExit = $LASTEXITCODE

          if ($standaloneExit -ne 0) {
            Write-Host "::error title=desktop-standalone-build::Standalone build failed with exit code $standaloneExit"
            if (Test-Path $diagFile) {
              Write-Host "::group::Standalone diagnostics JSON"
              Get-Content $diagFile
              Write-Host "::endgroup::"
              $diagOneLine = ((Get-Content $diagFile -Raw) -replace '\s+', ' ').Trim()
              Write-Host "::error title=desktop-standalone-diagnostics::$diagOneLine"
            }

            if (Test-Path $logFile) {
              $lines = Get-Content $logFile
              $tail = $lines | Select-Object -Last 200
              foreach ($line in $tail) {
                Write-Host "::error title=desktop-standalone-build-tail::$line"
              }
            }

            exit $standaloneExit
          }

          Get-Content $logFile

      - name: Assert Standalone Desktop Bundle
        run: pnpm --filter @forge/repo-studio run desktop:verify:standalone

      - name: Package RepoStudio Windows Desktop Directory
        shell: pwsh
        timeout-minutes: 20
        run: |
          pnpm --filter @forge/repo-studio run desktop:verify:standalone
          Push-Location packages/repo-studio
          try {
            .\node_modules\.bin\electron-builder.CMD --config electron-builder.json --win dir --publish never
          } finally {
            Pop-Location
          }

      - name: Smoke Launch Win-Unpacked RepoStudio
        shell: pwsh
        timeout-minutes: 12
        run: |
          $winUnpackedExe = "packages/repo-studio/dist/desktop/win-unpacked/RepoStudio.exe"
          if (-not (Test-Path $winUnpackedExe)) {
            Write-Host "::error title=desktop-runtime-smoke::Missing win-unpacked executable at $winUnpackedExe"
            exit 1
          }

          $previousElectronRunAsNode = $env:ELECTRON_RUN_AS_NODE
          Remove-Item Env:ELECTRON_RUN_AS_NODE -ErrorAction SilentlyContinue

          $process = Start-Process -FilePath $winUnpackedExe -PassThru
          $healthOk = $false
          try {
            for ($attempt = 0; $attempt -lt 72; $attempt++) {
              Start-Sleep -Seconds 5
              try {
                $response = Invoke-WebRequest -UseBasicParsing -Uri "http://127.0.0.1:3020/api/repo/health" -TimeoutSec 3
                if ($response.StatusCode -eq 200) {
                  $healthOk = $true
                  break
                }
              } catch {
                # keep waiting
              }
            }

            if (-not $healthOk) {
              Write-Host "::error title=desktop-runtime-smoke::Win-unpacked RepoStudio never reported healthy on /api/repo/health"
              Write-Host "::group::Diagnostics: AppData RepoStudio"
              Get-ChildItem "$env:APPDATA\RepoStudio" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName | Format-Table -AutoSize
              $startupLog = Join-Path $env:APPDATA "RepoStudio\desktop-startup.log"
              if (Test-Path $startupLog) {
                Write-Host "desktop-startup.log content:"
                Get-Content $startupLog -Tail 100
              }
              Write-Host "::endgroup::"
              Write-Host "::group::Diagnostics: Port 3020"
              Get-NetTCPConnection -LocalPort 3020 -ErrorAction SilentlyContinue | Format-Table -AutoSize
              Write-Host "::endgroup::"
              Write-Host "::group::Diagnostics: RepoStudio processes"
              Get-Process | Where-Object { $_.ProcessName -like "*Repo*" } | Format-Table Id, ProcessName, Path -AutoSize
              Write-Host "::endgroup::"
              exit 1
            }
          } finally {
            if ([string]::IsNullOrEmpty($previousElectronRunAsNode)) {
              Remove-Item Env:ELECTRON_RUN_AS_NODE -ErrorAction SilentlyContinue
            } else {
              $env:ELECTRON_RUN_AS_NODE = $previousElectronRunAsNode
            }
            Get-Process | Where-Object { $_.ProcessName -like "RepoStudio*" } | Stop-Process -Force -ErrorAction SilentlyContinue
            Get-NetTCPConnection -LocalPort 3020 -State Listen -ErrorAction SilentlyContinue |
              Select-Object -ExpandProperty OwningProcess -ErrorAction SilentlyContinue |
              ForEach-Object { Stop-Process -Id $_ -Force -ErrorAction SilentlyContinue }
          }

      - name: Package RepoStudio Attended Installer and Portable
        shell: pwsh
        timeout-minutes: 20
        run: |
          Push-Location packages/repo-studio
          try {
            .\node_modules\.bin\electron-builder.CMD --prepackaged dist/desktop/win-unpacked --config electron-builder.json --win nsis portable --publish never
          } finally {
            Pop-Location
          }

      - name: Package RepoStudio Silent Installer
        shell: pwsh
        timeout-minutes: 20
        run: |
          Push-Location packages/repo-studio
          try {
            .\node_modules\.bin\electron-builder.CMD --prepackaged dist/desktop/win-unpacked --config electron-builder.silent.json --win nsis --publish never
          } finally {
            Pop-Location
          }

      - name: Silent Install and Smoke Launch RepoStudio
        timeout-minutes: 20
        run: pnpm --filter @forge/repo-studio run desktop:smoke:silent -- --timeout-ms 720000 --idle-timeout-ms 300000 --health-timeout-ms 360000

      - name: Probe Installed Runtime Readiness
        timeout-minutes: 12
        run: pnpm --filter @forge/repo-studio run desktop:smoke:runtime -- --timeout-ms 360000

      - name: Upgrade and Repair Smoke (opt-in)
        if: ${{ vars.REPOSTUDIO_UPGRADE_REPAIR_SMOKE == '1' }}
        timeout-minutes: 30
        run: pnpm --filter @forge/repo-studio run desktop:smoke:upgrade-repair

      - name: Cleanup Owned RepoStudio Processes
        if: always()
        continue-on-error: true
        run: pnpm --filter @forge/repo-studio run desktop:cleanup:owned

      - name: Publish Desktop Smoke Summary
        if: always()
        continue-on-error: true
        shell: pwsh
        run: |
          $summaryFile = Join-Path $env:RUNNER_TEMP 'repostudio-smoke-summary.md'
          pnpm --filter @forge/repo-studio run desktop:smoke:summary -- --dir "$env:RUNNER_TEMP" --summary-file "$summaryFile" --write-summary
          if (Test-Path $summaryFile) {
            Get-Content $summaryFile | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

      - name: Upload Desktop Smoke Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repostudio-desktop-smoke-reports
          path: |
            ${{ runner.temp }}/repostudio-smoke-result*.json
            ${{ runner.temp }}/repostudio-runtime-probe*.json
            ${{ runner.temp }}/repostudio-upgrade-repair*.json
            ${{ runner.temp }}/repostudio-repair*.json
            ${{ runner.temp }}/repostudio-smoke-summary.md
          if-no-files-found: ignore

      - name: Collect Desktop Failure Diagnostics
        if: failure()
        shell: pwsh
        run: |
          $dest = Join-Path $env:RUNNER_TEMP 'desktop-failure-diagnostics'
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          $sources = @(
            (Join-Path $env:APPDATA 'RepoStudio\desktop-startup.log'),
            (Join-Path $env:APPDATA '@forgerepo-studio\desktop-startup.log')
          )

          foreach ($source in $sources) {
            if (Test-Path $source) {
              Copy-Item -Path $source -Destination (Join-Path $dest (Split-Path $source -Leaf)) -Force
            }
          }

      - name: Upload Desktop Failure Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: repostudio-desktop-failure-diagnostics
          path: |
            ${{ runner.temp }}/repostudio-smoke-result*.json
            ${{ runner.temp }}/repostudio-runtime-probe*.json
            ${{ runner.temp }}/repostudio-upgrade-repair*.json
            ${{ runner.temp }}/repostudio-repair*.json
            ${{ runner.temp }}/desktop-failure-diagnostics/*
          if-no-files-found: warn

      - name: Generate SHA256 Checksums
        shell: pwsh
        run: |
          $artifactDir = "packages/repo-studio/dist/desktop"
          $setupFile = Get-ChildItem -Path (Join-Path $artifactDir "RepoStudio Setup *.exe") |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          $portableFile = Get-ChildItem -Path (Join-Path $artifactDir "RepoStudio *.exe") |
            Where-Object { $_.Name -notlike "RepoStudio Setup *.exe" } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if (-not $setupFile -or -not $portableFile) {
            Write-Host "::error title=desktop-artifacts::Could not locate setup/portable executables in $artifactDir"
            Get-ChildItem -Path $artifactDir | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
            exit 1
          }
          $outFile = Join-Path $artifactDir "RepoStudio-$env:GITHUB_REF_NAME-sha256.txt"

          $setupHash = (Get-FileHash -Path $setupFile.FullName -Algorithm SHA256).Hash.ToLowerInvariant()
          $portableHash = (Get-FileHash -Path $portableFile.FullName -Algorithm SHA256).Hash.ToLowerInvariant()

          @(
            "$setupHash  $($setupFile.Name)"
            "$portableHash  $($portableFile.Name)"
          ) | Set-Content -Path $outFile
          Get-Content $outFile

      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repostudio-desktop-windows
          path: |
            packages/repo-studio/dist/desktop/RepoStudio Setup *.exe
            packages/repo-studio/dist/desktop/RepoStudio Silent Setup *.exe
            packages/repo-studio/dist/desktop/RepoStudio Setup *.exe.blockmap
            packages/repo-studio/dist/desktop/RepoStudio Silent Setup *.exe.blockmap
            packages/repo-studio/dist/desktop/RepoStudio [0-9]*.exe
            packages/repo-studio/dist/desktop/RepoStudio [0-9]*.exe.blockmap
            packages/repo-studio/dist/desktop/RepoStudio-*.txt

  release:
    runs-on: ubuntu-latest
    needs: package_windows
    timeout-minutes: 20
    steps:
      - name: Download Desktop Artifacts
        uses: actions/download-artifact@v4
        with:
          name: repostudio-desktop-windows
          path: release-artifacts

      - name: Download Desktop Smoke Reports
        uses: actions/download-artifact@v4
        with:
          name: repostudio-desktop-smoke-reports
          path: smoke-reports
        continue-on-error: true

      - name: Build Release Body
        shell: bash
        run: |
          BODY_FILE="release-body.md"
          {
            echo "## Desktop Release Status"
            echo
            if [ -f "smoke-reports/repostudio-smoke-summary.md" ]; then
              cat smoke-reports/repostudio-smoke-summary.md
            else
              echo "_Desktop smoke summary artifact was not found for this run._"
              echo
            fi
            echo "---"
            echo
            echo "_Generated release notes follow below._"
          } > "$BODY_FILE"
          cat "$BODY_FILE"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: RepoStudio ${{ github.ref_name }}
          body_path: release-body.md
          append_body: true
          generate_release_notes: true
          draft: false
          prerelease: false
          files: |
            release-artifacts/RepoStudio Setup *.exe
            release-artifacts/RepoStudio Silent Setup *.exe
            release-artifacts/RepoStudio Setup *.exe.blockmap
            release-artifacts/RepoStudio Silent Setup *.exe.blockmap
            release-artifacts/RepoStudio [0-9]*.exe
            release-artifacts/RepoStudio [0-9]*.exe.blockmap
            release-artifacts/RepoStudio-*.txt
