name: Release RepoStudio Desktop

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init required submodule
        run: |
          git submodule sync -- vendor/repo-studio-extensions
          git submodule update --init --depth 1 vendor/repo-studio-extensions

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Seed CI Env Files
        run: |
          cp apps/repo-studio/.env.example apps/repo-studio/.env
          cp apps/platform/.env.example apps/platform/.env

      - name: Verify Codegen
        run: pnpm --filter @forge/repo-studio-app run codegen

      - name: Verify Generated App Spec
        run: pnpm --filter @forge/repo-studio-app run check:codegen

      - name: Build Repo Studio App (Linux smoke)
        continue-on-error: true
        run: pnpm --filter @forge/repo-studio-app build

      - name: Verify Extension Registry Health
        run: pnpm --filter @forge/repo-studio-app run extensions:registry:health

      - name: Build Platform App
        run: pnpm --filter @forge/platform build

      - name: Build Docs App (Linux smoke)
        continue-on-error: true
        shell: bash
        env:
          NEXT_TELEMETRY_DISABLED: '1'
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          set -o pipefail
          LOG_FILE="$(mktemp)"
          set +e
          pnpm --filter @forge/docs build 2>&1 | tee "$LOG_FILE"
          BUILD_EXIT="${PIPESTATUS[0]}"
          set -e
          if [ "$BUILD_EXIT" -ne 0 ]; then
            echo "::error title=docs-build::Build failed with exit code ${BUILD_EXIT}"
            while IFS= read -r line; do
              printf '::error title=docs-build-tail::%s\n' "$line"
            done < <(tail -n 80 "$LOG_FILE")
            exit "$BUILD_EXIT"
          fi

      - name: Guard Workspace Semantics
        shell: bash
        run: |
          set -o pipefail
          LOG_FILE="$(mktemp)"
          set +e
          pnpm guard:workspace-semantics 2>&1 | tee "$LOG_FILE"
          GUARD_EXIT="${PIPESTATUS[0]}"
          set -e
          if [ "$GUARD_EXIT" -ne 0 ]; then
            echo "::error title=workspace-guard::Guard failed with exit code ${GUARD_EXIT}"
            while IFS= read -r line; do
              printf '::error title=workspace-guard-tail::%s\n' "$line"
            done < <(tail -n 80 "$LOG_FILE")
            exit "$GUARD_EXIT"
          fi

      - name: Run Hydration Doctor (Linux smoke)
        continue-on-error: true
        run: pnpm hydration:doctor

  package_windows:
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init required submodule
        run: |
          git submodule sync -- vendor/repo-studio-extensions
          git submodule update --init --depth 1 vendor/repo-studio-extensions

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install Windows Packaging Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wine64 nsis

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Seed Repo Studio CI Env
        run: cp apps/repo-studio/.env.example apps/repo-studio/.env

      - name: Build Strict Standalone Desktop Payload
        shell: bash
        run: |
          set -o pipefail
          LOG_FILE="$(mktemp)"
          set +e
          node packages/repo-studio/src/desktop/build.mjs --require-standalone 2>&1 | tee "$LOG_FILE"
          STANDALONE_EXIT="${PIPESTATUS[0]}"
          set -e
          if [ "$STANDALONE_EXIT" -ne 0 ]; then
            DIAG_FILE="packages/repo-studio/.desktop-build/failure-diagnostics.json"
            echo "::error title=desktop-standalone-build::Standalone build failed with exit code ${STANDALONE_EXIT}"
            if [ -f "$DIAG_FILE" ]; then
              echo "::group::Standalone diagnostics JSON"
              cat "$DIAG_FILE"
              echo "::endgroup::"
              DIAG_ONE_LINE="$(tr '\n' ' ' < "$DIAG_FILE" | sed -E 's/[[:space:]]+/ /g')"
              printf '::error title=desktop-standalone-diagnostics::%s\n' "$DIAG_ONE_LINE"
            fi
            while IFS= read -r line; do
              printf '::error title=desktop-standalone-build-tail::%s\n' "$line"
            done < <(tr '\r' '\n' < "$LOG_FILE" | tail -n 160)
            exit "$STANDALONE_EXIT"
          fi

      - name: Assert Standalone Desktop Bundle
        run: pnpm --filter @forge/repo-studio run desktop:verify:standalone

      - name: Package RepoStudio Windows Desktop
        run: pnpm --filter @forge/repo-studio exec electron-builder --config electron-builder.json --win nsis portable

      - name: Generate SHA256 Checksums
        shell: bash
        run: |
          artifact_dir="packages/repo-studio/dist/desktop"
          out_file="$artifact_dir/RepoStudio-${GITHUB_REF_NAME}-sha256.txt"
          (
            cd "$artifact_dir"
            sha256sum "RepoStudio Setup 0.1.1.exe"
            sha256sum "RepoStudio 0.1.1.exe"
          ) > "$out_file"
          cat "$out_file"

      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repostudio-desktop-windows
          path: |
            packages/repo-studio/dist/desktop/RepoStudio Setup 0.1.1.exe
            packages/repo-studio/dist/desktop/RepoStudio Setup 0.1.1.exe.blockmap
            packages/repo-studio/dist/desktop/RepoStudio 0.1.1.exe
            packages/repo-studio/dist/desktop/RepoStudio 0.1.1.exe.blockmap
            packages/repo-studio/dist/desktop/RepoStudio-v0.1.1-sha256.txt

  release:
    runs-on: ubuntu-latest
    needs: package_windows
    steps:
      - name: Download Desktop Artifacts
        uses: actions/download-artifact@v4
        with:
          name: repostudio-desktop-windows
          path: release-artifacts

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: RepoStudio ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: |
            release-artifacts/RepoStudio Setup 0.1.1.exe
            release-artifacts/RepoStudio Setup 0.1.1.exe.blockmap
            release-artifacts/RepoStudio 0.1.1.exe
            release-artifacts/RepoStudio 0.1.1.exe.blockmap
            release-artifacts/RepoStudio-v0.1.1-sha256.txt
