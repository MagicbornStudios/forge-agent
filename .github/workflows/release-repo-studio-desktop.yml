name: Release RepoStudio Desktop

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init required submodule
        run: |
          git submodule sync -- vendor/repo-studio-extensions
          git submodule update --init --depth 1 vendor/repo-studio-extensions

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Seed CI Env Files
        run: |
          cp apps/repo-studio/.env.example apps/repo-studio/.env
          cp apps/platform/.env.example apps/platform/.env

      - name: Verify Codegen
        run: pnpm --filter @forge/repo-studio-app run codegen

      - name: Verify Generated App Spec
        run: pnpm --filter @forge/repo-studio-app run check:codegen

      - name: Build Repo Studio App (Linux smoke)
        continue-on-error: true
        run: pnpm --filter @forge/repo-studio-app build

      - name: Verify Extension Registry Health
        run: pnpm --filter @forge/repo-studio-app run extensions:registry:health

      - name: Build Platform App
        run: pnpm --filter @forge/platform build

      - name: Build Docs App (Linux smoke)
        continue-on-error: true
        shell: bash
        env:
          NEXT_TELEMETRY_DISABLED: '1'
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          set -o pipefail
          LOG_FILE="$(mktemp)"
          set +e
          pnpm --filter @forge/docs build 2>&1 | tee "$LOG_FILE"
          BUILD_EXIT="${PIPESTATUS[0]}"
          set -e
          if [ "$BUILD_EXIT" -ne 0 ]; then
            echo "::error title=docs-build::Build failed with exit code ${BUILD_EXIT}"
            while IFS= read -r line; do
              printf '::error title=docs-build-tail::%s\n' "$line"
            done < <(tail -n 80 "$LOG_FILE")
            exit "$BUILD_EXIT"
          fi

      - name: Guard Workspace Semantics
        shell: bash
        run: |
          set -o pipefail
          LOG_FILE="$(mktemp)"
          set +e
          pnpm guard:workspace-semantics 2>&1 | tee "$LOG_FILE"
          GUARD_EXIT="${PIPESTATUS[0]}"
          set -e
          if [ "$GUARD_EXIT" -ne 0 ]; then
            echo "::error title=workspace-guard::Guard failed with exit code ${GUARD_EXIT}"
            while IFS= read -r line; do
              printf '::error title=workspace-guard-tail::%s\n' "$line"
            done < <(tail -n 80 "$LOG_FILE")
            exit "$GUARD_EXIT"
          fi

      - name: Run Hydration Doctor (Linux smoke)
        continue-on-error: true
        run: pnpm hydration:doctor

  package_windows:
    runs-on: windows-latest
    needs: verify
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init required submodule
        run: |
          git submodule sync -- vendor/repo-studio-extensions
          git submodule update --init --depth 1 vendor/repo-studio-extensions

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Pin pnpm store to workspace drive
        shell: pwsh
        run: |
          pnpm config set store-dir "$env:GITHUB_WORKSPACE\\.pnpm-store"

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Seed Repo Studio CI Env
        run: Copy-Item apps/repo-studio/.env.example apps/repo-studio/.env

      - name: Build Strict Standalone Desktop Payload
        shell: pwsh
        run: |
          $logFile = Join-Path $env:RUNNER_TEMP 'desktop-standalone-build.log'
          $diagFile = 'packages/repo-studio/.desktop-build/failure-diagnostics.json'

          $command = "node packages/repo-studio/src/desktop/build.mjs --require-standalone"
          & cmd /d /s /c "$command 1>$logFile 2>&1"
          $standaloneExit = $LASTEXITCODE

          if ($standaloneExit -ne 0) {
            Write-Host "::error title=desktop-standalone-build::Standalone build failed with exit code $standaloneExit"
            if (Test-Path $diagFile) {
              Write-Host "::group::Standalone diagnostics JSON"
              Get-Content $diagFile
              Write-Host "::endgroup::"
              $diagOneLine = ((Get-Content $diagFile -Raw) -replace '\s+', ' ').Trim()
              Write-Host "::error title=desktop-standalone-diagnostics::$diagOneLine"
            }

            if (Test-Path $logFile) {
              $lines = Get-Content $logFile
              $tail = $lines | Select-Object -Last 200
              foreach ($line in $tail) {
                Write-Host "::error title=desktop-standalone-build-tail::$line"
              }
            }

            exit $standaloneExit
          }

          Get-Content $logFile

      - name: Assert Standalone Desktop Bundle
        run: pnpm --filter @forge/repo-studio run desktop:verify:standalone

      - name: Package RepoStudio Windows Desktop
        run: pnpm --filter @forge/repo-studio exec electron-builder --config electron-builder.json --win nsis portable

      - name: Generate SHA256 Checksums
        shell: pwsh
        run: |
          $artifactDir = "packages/repo-studio/dist/desktop"
          $setupFile = Get-ChildItem -Path (Join-Path $artifactDir "RepoStudio Setup *.exe") |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          $portableFile = Get-ChildItem -Path (Join-Path $artifactDir "RepoStudio *.exe") |
            Where-Object { $_.Name -notlike "RepoStudio Setup *.exe" } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if (-not $setupFile -or -not $portableFile) {
            Write-Host "::error title=desktop-artifacts::Could not locate setup/portable executables in $artifactDir"
            Get-ChildItem -Path $artifactDir | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
            exit 1
          }
          $outFile = Join-Path $artifactDir "RepoStudio-$env:GITHUB_REF_NAME-sha256.txt"

          $setupHash = (Get-FileHash -Path $setupFile.FullName -Algorithm SHA256).Hash.ToLowerInvariant()
          $portableHash = (Get-FileHash -Path $portableFile.FullName -Algorithm SHA256).Hash.ToLowerInvariant()

          @(
            "$setupHash  $($setupFile.Name)"
            "$portableHash  $($portableFile.Name)"
          ) | Set-Content -Path $outFile
          Get-Content $outFile

      - name: Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repostudio-desktop-windows
          path: |
            packages/repo-studio/dist/desktop/RepoStudio Setup *.exe
            packages/repo-studio/dist/desktop/RepoStudio Setup *.exe.blockmap
            packages/repo-studio/dist/desktop/RepoStudio [0-9]*.exe
            packages/repo-studio/dist/desktop/RepoStudio [0-9]*.exe.blockmap
            packages/repo-studio/dist/desktop/RepoStudio-*.txt

  release:
    runs-on: ubuntu-latest
    needs: package_windows
    steps:
      - name: Download Desktop Artifacts
        uses: actions/download-artifact@v4
        with:
          name: repostudio-desktop-windows
          path: release-artifacts

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: RepoStudio ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
          files: |
            release-artifacts/RepoStudio Setup *.exe
            release-artifacts/RepoStudio Setup *.exe.blockmap
            release-artifacts/RepoStudio [0-9]*.exe
            release-artifacts/RepoStudio [0-9]*.exe.blockmap
            release-artifacts/RepoStudio-*.txt
