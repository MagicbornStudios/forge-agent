---
title: Model routing and OpenRouter
---

# Model routing and OpenRouter

We use **OpenRouter** for chat, structured output, plan generation, and image generation. The model list is **fetched from OpenRouter's API**; we only maintain **static defaults** for the free fallback chain, image model, and task model.

## SDK and API

- **OpenAI SDK + @ai-sdk/openai**: We use OpenAI SDK with `baseURL` for OpenRouter and `createOpenAI` from `@ai-sdk/openai` (no OpenRouter SDK). We inject fallbacks via a custom fetch that adds `models: [primary, ...fallbacks]` to the request body. See `apps/studio/lib/model-router/openrouter-fetch.ts`.
- **Model list**: Fetched from OpenRouter `GET /api/v1/models` (see `apps/studio/lib/openrouter-models.ts`). Cached for 5 minutes. Returned by `GET /api/model-settings` as `registry` so the ModelSwitcher and settings can show the current list without maintaining it in code.
- **Responses compatibility**: CopilotKit BuiltInAgent uses the OpenAI **responses** API, which requires **responses v2**. Some OpenRouter models (e.g. Gemini/Claude) return v3 responses and are incompatible. We tag models with `supportsResponsesV2` and filter CopilotKit selection to v2‑compatible models with a safe fallback. Assistant‑ui chat uses the **chat** pipeline so it can use a broader set of models without responses‑v3 failures.
- **Static defaults** (only list we maintain): `apps/studio/lib/model-router/defaults.ts` defines:
  - **DEFAULT_FREE_CHAT_MODEL_IDS**: default fallback chain for chat (free models, order = preference). Used when the user has not set preferences.
  - **DEFAULT_IMAGE_MODEL**: default for image generation; override with env `OPENROUTER_IMAGE_MODEL`.
  - **DEFAULT_TASK_MODEL**: default for forge/plan and structured-output (same as first free chat default).

## Modes and switching

- **Auto**: Primary = first in the user's enabled list (or default free chain); fallbacks = rest of that list. OpenRouter receives `models: [primary, ...fallbacks]` and retries on rate limit / 5xx within the same request.
- **Manual**: User picks one model; no fallbacks.
- **Override**: Client can send header `x-forge-model` (e.g. from app/editor/viewport setting for `ai.model`). When set, we use that model as primary and no fallbacks for that request.

## ModelSwitcher component

- **Location**: `apps/studio/components/model-switcher/ModelSwitcher.tsx`.
- **Data**: Gets `registry` (OpenRouter model list) and preferences from `GET /api/model-settings`. Store: `apps/studio/lib/model-router/store.ts`.
- **UI**: Auto vs Manual; in Auto, user enables/disables models and order = primary then fallbacks; in Manual, user picks one. When `FREE_ONLY` is true (default), only free-tier models from the OpenRouter list are shown. If the registry is empty (e.g. no API key), a short message is shown.
- **CopilotKit filter**: The ModelSwitcher includes a “Responses v2 only” filter (required for CopilotKit). It defaults on and hides incompatible models when selecting for the CopilotKit surface.
  - **Setting key**: `ai.responsesCompatOnly` (app scope) persists the filter state.

## Runtime and router location

The **CopilotKit runtime** and **model router** (server-state, registry, openrouter-config, responses-compat) live **only** in `apps/studio`. There is no second runtime or model router at repo root. All API routes in use are under `apps/studio/app/api/`.

## Model routing matrix (contract for tests)

For each surface, this table is the source of truth for which route, which API (chat vs responses), where the model ID comes from, and how override works. Keep in sync with handler code and tests.

| Use case | Route | API | Model source | Override |
|----------|--------|-----|--------------|----------|
| CopilotKit (sidebar) | `POST /api/copilotkit` | **Responses** (BuiltInAgent); **v2 only** — responses-compat + fallback model | server-state `resolvePrimaryAndFallbacks()` | Header `x-forge-model` (from settings `ai.model` when not app/auto); when set, fallbacks = [] |
| assistant-ui (Workbench / Strategy chat) | `POST /api/assistant-chat` | **Chat** (`streamText`); no v2 filter | Same server-state | Body `config.modelName` (optional); when set, fallbacks = [] |
| forge/plan | `POST /api/forge/plan` | Chat-style with JSON schema | Same server-state | None |
| structured-output | `POST /api/structured-output` | Chat-style with JSON schema | Same server-state | None |
| image-generate | `POST /api/image-generate` | OpenRouter image modality | Env `OPENROUTER_IMAGE_MODEL` or `DEFAULT_IMAGE_MODEL` | Env only |
| video | — | Not implemented (stub) | — | — |

- **Persistence:** Model preferences (mode, manualModelId, enabledModelIds) are in-memory in server-state (reset on restart). Client pushes to server via `POST /api/model-settings`; server does not persist to DB. Settings `ai.model` is used by the client to set `x-forge-model` for CopilotKit only.

## Where model is chosen (summary)

| Use case | Source | Override |
|----------|--------|----------|
| Chat / CopilotKit | Preferences (primary + fallbacks) or `x-forge-model` | Header `x-forge-model` from settings |
| forge/plan | Preferences (primary + fallbacks) | None today |
| structured-output | Preferences (primary + fallbacks) | None today |
| image-generate | Env `OPENROUTER_IMAGE_MODEL` or `DEFAULT_IMAGE_MODEL` | Env only |

## How to avoid auto-switching (single model)

- **Manual mode**: In ModelSwitcher, choose "Manual" and select one model. All chat requests use that model with no fallbacks.
- **Per-request**: Set `ai.model` at app/editor/viewport level to a specific model ID (not "auto"); the client sends `x-forge-model` and we use that model only for that request.
- **Image**: Uses a single model (env or default); no fallbacks.

## Provider stack (text / image / audio / video)

| Capability | Provider | Status / notes |
|------------|----------|----------------|
| Chat / streaming | OpenRouter | Primary + fallbacks via custom fetch |
| Structured output | OpenRouter | Same model resolution |
| Plan (forge) | OpenRouter | Same model resolution |
| Image generation | OpenRouter | Dedicated model (env or default) |
| Image vision | OpenRouter | Model-dependent |
| Audio TTS | ElevenLabs | Character voices, preview. Configure `ELEVENLABS_API_KEY`. |
| Audio STT | - | Not implemented (e.g. Whisper when we add it) |
| Video generation | OpenAI Sora | Planned. OpenRouter does not offer video. |

OpenRouter covers text LLMs and limited image; we use **ElevenLabs** for audio TTS and plan **OpenAI Sora** (or equivalent) for video when we add it.

## Verification (optional)

To confirm that the model ID and chat API shape work against OpenRouter (e.g. in CI with a secret or locally), run:

```bash
OPENROUTER_API_KEY=... pnpm run verify-openrouter
```

This runs `scripts/verify-openrouter-model-routing.mjs`, which calls OpenRouter's chat completions endpoint with a known model and prints the response. Do not run it from Jest (network + secrets).

## References

- [03-copilotkit-and-agents.mdx](./03-copilotkit-and-agents.mdx) - Runtime and agent (Section 7).
- [01-unified-workspace.mdx](./01-unified-workspace.mdx) - Model routing and OpenRouter (short section).
- OpenRouter: [List models](https://openrouter.ai/docs/api-reference/list-available-models), [Model fallbacks](https://openrouter.ai/docs/guides/routing/model-fallbacks).
