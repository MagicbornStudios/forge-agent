---
title: "Editor mode design: extending AI and patterns"

created: 2026-02-04
updated: 2026-02-07
---

# Editor mode design: extending AI and patterns

## Design patterns

### Extending the AI (actions, context, delegation, prompts)

1. **Context**: Expose minimal, stable state via `useCopilotReadable` (or the domain contract's `getContextSnapshot()`). Include `modeId`, selection summary, and domain-specific state (e.g. graph summary, track count). Shell context is registered in `AppShell`; domain context is registered when the mode mounts (e.g. `useDomainCopilot(forgeContract)`).

2. **Actions**: Register with `useCopilotAction`. Use a **domain prefix** (e.g. `forge_createNode`, `video_addTrack`) to avoid collisions. Each action: name, description, parameters, handler; optional `render` for generative UI (confirmations, previews). Domain actions are created in `lib/domains/<domain>/copilot/actions.ts` and registered via `useDomainCopilot`.

3. **Delegation**: The main agent can call shell actions (`switchMode`, `openMode`, `closeMode`). For sub-tasks, you can add co-agents (`useCoAgent` / `useAgent`). See [17-co-agents-and-multi-agent.mdx](./17-co-agents-and-multi-agent.mdx).

4. **Prompts / instructions**: Base instructions come from the app-level settings and the CopilotKit provider. Domain-specific instructions come from the contract's `getInstructions()` and are layered as additional instructions. Keep instructions short and mention available action prefixes.

### What to expect with auto model (free-first fallbacks)

- **Auto mode**: App resolves a primary model plus a fallback chain using `resolvePrimaryAndFallbacks()`.
- **Manual mode**: User picks a specific primary model; fallbacks still apply unless disabled.
- **Fallbacks**: Requests include `models: [primary, ...fallbacks]` so OpenRouter retries within a single request on 429/5xx.
- **No health dots**: We do not track per-model health or cooldown in the client; fallbacks handle rate limits.

### Adding a mode or editor

1. **New mode**: Add a mode id to `EditorModeId` in `lib/app-shell/store.ts`. Create a mode component (e.g. `XMode`) using `EditorShell`, wire domain store, `useXContract` + `useDomainCopilot`. Add tab and render branch in `AppShell`. Register shell context/actions (mode name, switch/open/close) if not already generic.
2. **New editor type**: Implement the editor in the mode's **main** slot. Expose selection (and optional viewport handle) for `revealSelection`. If you add multiple editor windows/tabs later, extend route state with `editors[]` and `sessions` per editor; see [01-unified-workspace.mdx](./architecture/01-unified-workspace.mdx).
3. **Register agents**: Domain contract registers context and actions when the mode is active. Optionally add a co-agent (see [17-co-agents-and-multi-agent.mdx](./17-co-agents-and-multi-agent.mdx)).

## References

- [Adding domain actions](./14-adding-domain-actions.mdx)
- [Unified editor architecture](./architecture/01-unified-workspace.mdx)
- [Errors and attempts](./agent-artifacts/core/errors-and-attempts.md) (do not repeat)
