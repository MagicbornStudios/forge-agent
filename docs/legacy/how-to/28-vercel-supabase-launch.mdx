---
title: 28 - Vercel + Supabase launch
created: 2026-02-12
updated: 2026-02-12
---

# 28 - Vercel + Supabase launch

End-to-end runbook for deploying Studio and Platform to Vercel with a shared Supabase Postgres database.

## Overview

- **Deploy topology:** Two Vercel projects from the same monorepo (`apps/studio`, `apps/platform`).
- **Database:** Single Supabase Postgres instance; Studio connects directly; Platform talks to Studio APIs.
- **Local dev:** SQLite by default (no `DATABASE_URI`); Postgres when `DATABASE_URI` is set (e.g. for cloud testing).
- **Env:** Local portal (`pnpm env:portal`) and Vercel sync (`pnpm env:sync:vercel`) handle all setup.

## Prerequisites

- Vercel account
- Supabase project
- Vercel API token (for env sync)

## Step 1: Create Vercel projects

1. Import the monorepo twice (or create two projects linked to the same repo).
2. **Studio project:**
   - Root Directory: `apps/studio`
   - Framework: Next.js
   - Build command: `pnpm run build:ci` (runs migrations before build) or `pnpm run build`
3. **Platform project:**
   - Root Directory: `apps/platform`
   - Framework: Next.js
   - Build command: `pnpm run build`

## Step 2: Supabase database

1. Create a new Supabase project.
2. Go to **Settings â†’ Database** and copy the connection string.
3. **Session mode vs transaction mode:** Use the **Session** pooler for Payload (connection-bound); Transaction pooler may cause issues with migrations or long-lived connections.
4. Recommended: use the direct connection string for migrations (`postgresql://postgres:[PASSWORD]@db.[PROJECT].supabase.co:5432/postgres`) and the pooler for runtime if needed.

## Step 3: Environment setup via portal

1. Run `pnpm env:portal`.
2. Fill required keys for **Studio** and **Platform**.
3. For cloud:
   - `DATABASE_URI`: Supabase connection string (Postgres)
   - `NEXT_PUBLIC_APP_URL`: Studio production URL (e.g. `https://studio.yourdomain.com`)
   - `NEXT_PUBLIC_STUDIO_APP_URL`: Studio URL (same as above when Platform links to Studio)
   - `PAYLOAD_SECRET`, `OPENROUTER_API_KEY`, Stripe keys, etc.
4. Fill the **Vercel** section:
   - `VERCEL_API_TOKEN`
   - `VERCEL_TEAM_ID` (optional, for teams)
   - `VERCEL_PROJECT_STUDIO`: project id or name
   - `VERCEL_PROJECT_PLATFORM`: project id or name
5. Click **Save**, then **Sync to Vercel**.

Alternatively: configure Vercel env vars manually in the dashboard, and use `pnpm env:sync:vercel` to push from local `.env.local` files.

## Step 4: Migrations (Studio)

Studio uses Payload migrations. On deploy:

- **Option A:** Set Vercel build command to `pnpm run build:ci` (runs `db:migrate` then `build`).
- **Option B:** Run migrations separately before deploy (e.g. `pnpm --filter @forge/studio db:migrate` in CI or from local with `DATABASE_URI` set).

Migrations live in `apps/studio/migrations/`. A fresh Supabase DB is initialized from these; no SQLite data migration.

## Troubleshooting

### Pooler connection strings

- Supabase offers **Session** and **Transaction** poolers.
- Payload expects session-bound connections; prefer **Session** pooler or direct connection.
- If migrations fail with pooler, use the direct connection string for `db:migrate` and optionally a pooler for runtime.

### Seed gating

- Seed runs only in local development (`NODE_ENV=development`, `VERCEL!==1`, `CI!==true`).
- Preview and production never auto-seed; this is intentional.

### Migration sequencing

- Run migrations before the first build, or use `build:ci`.
- If a build fails with "relation does not exist", migrations did not run; ensure `build:ci` or a prior migration step.

### CORS

- Studio CORS allowlist must include the Platform production URL.
- Set `CORS_ALLOWED_ORIGINS` or `PLATFORM_APP_URL` in env; see `apps/studio/lib/server/cors.ts`.

## Commands reference

| Command | Purpose |
|--------|---------|
| `pnpm env:portal` | Web UI for env + Vercel config |
| `pnpm env:sync:vercel` | One-shot sync of `.env.local` to Vercel |
| `pnpm env:doctor` | Check env drift |
| `pnpm --filter @forge/studio db:migrate` | Run Payload migrations |
