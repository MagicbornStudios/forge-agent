---
phase: 03-multi-loop-orchestration-and-dual-assistant-editors
plan: 04
wave: 4
depends_on:
  - '03-02'
  - '03-03'
files_modified:
  - apps/repo-studio/app/api/assistant-chat/route.ts
  - apps/repo-studio/src/lib/codex-session.ts
  - apps/repo-studio/src/components/features/assistant/AssistantWorkspace.tsx
  - packages/repo-studio/src/server/server.mjs
  - packages/repo-studio/src/server/ui.mjs
autonomous: true
must_haves:
  truths:
    - "Codex app-server event mapping is deterministic for text, approval requests, and terminal turn states."
    - "Review queue apply/reject actions remain idempotent and never auto-apply file changes."
  artifacts:
    - path: ".planning/phases/03-multi-loop-orchestration-and-dual-assistant-editors/03-04-SUMMARY.md"
      provides: "Execution summary for Codex IDE parity hardening."
      min_lines: 10
  key_links:
    - from: ".planning/ROADMAP.md"
      to: ".planning/phases/03-multi-loop-orchestration-and-dual-assistant-editors/03-04-SUMMARY.md"
      via: "phase-to-summary traceability"
---

<objective>
Close remaining Phase 03 parity gaps for Codex-first in-panel coding workflows, with robust review queue safety and package runtime contract alignment.
</objective>

<context>
@apps/repo-studio/app/api
@apps/repo-studio/src/components/features/assistant
@apps/repo-studio/src/lib/codex-session.ts
@packages/repo-studio/src/server
</context>

<tasks>
<task type="auto">
  <name>Harden Codex protocol event mapping</name>
  <files>apps/repo-studio/src/lib/codex-session.ts, apps/repo-studio/app/api/assistant-chat/route.ts</files>
  <action>Improve `turn/*` and `item/*` event normalization, add richer approval metadata extraction, and ensure stable finish semantics for streamed assistant responses.</action>
  <verify>Codex turn streams always end with deterministic `finish` parts and emit proposal payloads for approval requests.</verify>
  <done>Codex assistant is reliable under long turns and mixed event payload shapes.</done>
</task>

<task type="auto">
  <name>Improve proposal and diff fidelity</name>
  <files>apps/repo-studio/src/lib/proposals.ts, apps/repo-studio/src/components/features/review-queue/ReviewQueueWorkspace.tsx</files>
  <action>Store richer per-file proposal metadata and tighten apply/reject messages/UX for repeated actions.</action>
  <verify>Apply/reject stays idempotent and proposal rows expose enough context to review safely.</verify>
  <done>Review queue is trustworthy for approval-gated writes.</done>
</task>

<task type="auto">
  <name>Finish package runtime API/UI parity checks</name>
  <files>packages/repo-studio/src/server/server.mjs, packages/repo-studio/src/server/ui.mjs</files>
  <action>Align package runtime response contracts and route diagnostics with app runtime for codex/proposal/file workflows.</action>
  <verify>`forge-repo-studio doctor --json` and package runtime route probes return parity-critical fields.</verify>
  <done>npm consumers receive predictable RepoStudio behavior with clear limitations where app runtime remains preferred.</done>
</task>
</tasks>
