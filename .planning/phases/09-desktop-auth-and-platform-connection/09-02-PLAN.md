---
phase: 09-desktop-auth-and-platform-connection
plan: 02
wave: 2
depends_on:
  - '09-01'
files_modified:
  - packages/repo-studio/src/security/contracts.mjs
  - packages/repo-studio/src/security/keytar-store.mjs
  - packages/repo-studio/src/security/safestorage-store.mjs
  - packages/repo-studio/src/security/memory-store.mjs
  - packages/repo-studio/src/security/credential-manager.mjs
  - packages/repo-studio/src/security/redaction.mjs
  - packages/repo-studio/src/security/state-file.mjs
  - packages/repo-studio/src/desktop/ipc-channels.mjs
  - packages/repo-studio/src/desktop/main.mjs
  - packages/repo-studio/src/desktop/preload.mjs
  - packages/repo-studio/package.json
  - apps/repo-studio/app/api/repo/auth/*
  - apps/repo-studio/src/lib/desktop-runtime.ts
  - apps/repo-studio/src/lib/repo-studio-config.ts
autonomous: true
must_haves:
  truths:
    - "Desktop token lifecycle must persist credentials only in secure providers (keytar primary, safeStorage fallback, memory last-resort)."
    - "Web/app runtime must not persist desktop tokens outside process memory."
    - "Outputs must keep Forge Loop artifacts traceable and deterministic for repeat runs."
  artifacts:
    - path: ".planning/phases/09-desktop-auth-and-platform-connection/09-02-SUMMARY.md"
      provides: "Secure desktop credential lifecycle and IPC bridge execution summary."
      min_lines: 10
  key_links:
    - from: ".planning/ANALYSIS-REFERENCES.md"
      to: "repo_studio_analysis/DECISIONS.md"
      via: "token storage and desktop runtime decisions"
    - from: ".planning/ANALYSIS-REFERENCES.md"
      to: "repo_studio_analysis/PRD.md"
      via: "phase direction traceability"
---

<objective>
Implement secure desktop credential storage lifecycle and expose it through typed desktop IPC/auth routes.
</objective>

<context>
@.planning/ANALYSIS-REFERENCES.md
@repo_studio_analysis
@forge_env_analysis
@ide_navigation_analysis
</context>

<tasks>
<task type="auto">
  <name>Build secure credential manager with fallback provider chain</name>
  <files>packages/repo-studio/src/security/*, packages/repo-studio/package.json</files>
  <action>Implement token save/load/clear through keytar, then safeStorage-backed encrypted file, then memory provider; centralize redaction and secret-safe logs.</action>
  <verify>Provider selection is deterministic and tested; no token plaintext is emitted in logs/config/local overrides.</verify>
  <done>Desktop credential lifecycle survives restart with secure-store priority and graceful fallback.</done>
</task>

<task type="auto">
  <name>Wire desktop IPC bridge for auth actions</name>
  <files>packages/repo-studio/src/desktop/ipc-channels.mjs, packages/repo-studio/src/desktop/main.mjs, packages/repo-studio/src/desktop/preload.mjs, apps/repo-studio/src/lib/desktop-runtime.ts</files>
  <action>Add `auth:status|connect|disconnect|validate` IPC handlers and renderer bridge wrappers with typed payload contract.</action>
  <verify>Desktop renderer can connect/validate/disconnect and receives provider/capability metadata; bridge rejects unsafe payloads.</verify>
  <done>Desktop runtime exposes secure auth lifecycle controls without broad token exposure.</done>
</task>

<task type="auto">
  <name>Add app auth route baseline for parity and dev-mode memory flow</name>
  <files>apps/repo-studio/app/api/repo/auth/*, apps/repo-studio/src/lib/repo-studio-config.ts</files>
  <action>Create `status|connect|disconnect|validate` routes with session-memory fallback for web runtime and desktop-bridge preference when available.</action>
  <verify>Web runtime retains non-persistent behavior; desktop runtime path uses bridge and returns unified payload shape.</verify>
  <done>Auth API baseline exists for both runtime modes with consistent contracts.</done>
</task>

<task type="auto">
  <name>Update loop artifacts and traceability</name>
  <files>.planning/STATE.md, .planning/TASK-REGISTRY.md, .planning/DECISIONS.md, .planning/ERRORS.md</files>
  <action>Record outcomes, blockers, and requirement trace links for this plan wave.</action>
  <verify>forge-loop progress --json reflects current plan/task routing accurately.</verify>
  <done>Loop state and roadmap remain consistent with implementation state.</done>
</task>
</tasks>
