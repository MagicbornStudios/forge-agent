---
phase: 09-desktop-auth-and-platform-connection
plan: 01
wave: 1
depends_on: []
files_modified:
  - apps/studio/lib/server/api-keys.ts
  - apps/studio/payload/collections/api-keys.ts
  - apps/studio/app/api/me/api-keys/route.ts
  - apps/studio/app/api/repo-studio/desktop/connection/route.ts
  - apps/studio/lib/server/repo-studio-desktop-auth.ts
  - apps/studio/__tests__/server/repo-studio-desktop-auth.test.ts
autonomous: true
must_haves:
  truths:
    - "Studio API key scope handling must support repo-studio desktop scope taxonomy without regressing existing AI scope behavior."
    - "Desktop connection validation endpoint must return deterministic capability payloads and actionable auth/scope errors."
    - "Outputs must keep Forge Loop artifacts traceable and deterministic for repeat runs."
  artifacts:
    - path: ".planning/phases/09-desktop-auth-and-platform-connection/09-01-SUMMARY.md"
      provides: "Scope-model rollout and platform validation endpoint execution summary."
      min_lines: 10
  key_links:
    - from: ".planning/ANALYSIS-REFERENCES.md"
      to: "repo_studio_analysis/DECISIONS.md"
      via: "desktop auth scope taxonomy"
    - from: ".planning/ANALYSIS-REFERENCES.md"
      to: "repo_studio_analysis/PRD.md"
      via: "phase direction traceability"
---

<objective>
Extend Studio API-key scope contracts and add a platform-side desktop connection validation endpoint.
</objective>

<context>
@.planning/ANALYSIS-REFERENCES.md
@repo_studio_analysis
@forge_env_analysis
@ide_navigation_analysis
</context>

<tasks>
<task type="auto">
  <name>Implement repo-studio scope taxonomy in Studio auth surfaces</name>
  <files>apps/studio/lib/server/api-keys.ts, apps/studio/payload/collections/api-keys.ts, apps/studio/app/api/me/api-keys/route.ts</files>
  <action>Add `repo-studio.*|connect|read|write` as valid scopes, preserve default AI scope behavior, and keep API key creation/validation stable.</action>
  <verify>Scope sanitization includes repo-studio values; existing AI scope requests and auth checks continue to pass.</verify>
  <done>Studio API key lifecycle supports repo-studio scopes with backward compatibility.</done>
</task>

<task type="auto">
  <name>Add platform validation endpoint for desktop capability introspection</name>
  <files>apps/studio/app/api/repo-studio/desktop/connection/route.ts, apps/studio/lib/server/repo-studio-desktop-auth.ts</files>
  <action>Create `GET /api/repo-studio/desktop/connection` requiring `repo-studio.connect` with deterministic `200|401|403` contracts and capability booleans.</action>
  <verify>Token/session auth paths emit expected authType + scope/capability payload; missing scope returns actionable `403`.</verify>
  <done>RepoStudio desktop can validate platform connection and capability envelope through one canonical endpoint.</done>
</task>

<task type="auto">
  <name>Add auth unit coverage for scope allow/deny behavior</name>
  <files>apps/studio/__tests__/server/repo-studio-desktop-auth.test.ts</files>
  <action>Cover scope parsing, capability mapping, and endpoint auth guard failures for unauthorized/missing-scope cases.</action>
  <verify>`pnpm --filter @forge/studio test -- --runInBand` includes new tests without flake.</verify>
  <done>Auth regression surface is locked with deterministic tests.</done>
</task>

<task type="auto">
  <name>Update loop artifacts and traceability</name>
  <files>.planning/STATE.md, .planning/TASK-REGISTRY.md, .planning/DECISIONS.md, .planning/ERRORS.md</files>
  <action>Record outcomes, blockers, and requirement trace links for this plan wave.</action>
  <verify>forge-loop progress --json reflects current plan/task routing accurately.</verify>
  <done>Loop state and roadmap remain consistent with implementation state.</done>
</task>
</tasks>
