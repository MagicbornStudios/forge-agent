---
phase: 05-settings-foundation-and-canonical-env-ux
plan: 03
wave: 3
depends_on:
  - '05-02'
files_modified:
  - packages/forge-env/src/lib/target-service.mjs
  - packages/forge-env/src/commands/target-read.mjs
  - packages/forge-env/src/commands/target-write.mjs
  - packages/forge-env/src/cli.mjs
  - packages/forge-env/src/commands/doctor.mjs
  - packages/forge-env/src/__tests__/target-service.test.mjs
  - apps/repo-studio/app/api/env/target/[targetId]/route.ts
autonomous: true
must_haves:
  truths:
    - "Env target API responses must return full union keys with provenance, metadata, and readiness details."
    - "Mode-scoped writes must target `.env.local`, `.env.development.local`, and `.env.production.local` respectively."
    - "Headless mode writes must fail deterministically with actionable remediation."
  artifacts:
    - path: ".planning/phases/05-settings-foundation-and-canonical-env-ux/05-03-SUMMARY.md"
      provides: "Summary of env target read/write API implementation and validation results."
      min_lines: 12
  key_links:
    - from: ".planning/ANALYSIS-REFERENCES.md"
      to: "forge_env_analysis/API-CONTRACT.md"
      via: "target read/write request and response contract alignment"
    - from: ".planning/ANALYSIS-REFERENCES.md"
      to: "repo_studio_analysis/PRD.md"
      via: "RepoStudio env editing contract"
---

<objective>
Implement canonical env target read/write APIs with mode-aware writes, full-key snapshots, and deterministic headless protections.
</objective>

<tasks>
<task type="auto">
  <name>Build shared forge-env target service</name>
  <files>packages/forge-env/src/lib/target-service.mjs; packages/forge-env/src/commands/target-read.mjs; packages/forge-env/src/commands/target-write.mjs; packages/forge-env/src/cli.mjs</files>
  <action>Expose target read/write commands that return API-grade JSON payloads and support profile/mode/runner arguments.</action>
  <verify>`forge-env target-read root --json` and `forge-env target-write root --mode local --values '{...}' --json` return contract-compliant payloads.</verify>
  <done>Shared CLI and service contracts are stable and reusable.</done>
</task>

<task type="auto">
  <name>Integrate RepoStudio env target route</name>
  <files>apps/repo-studio/app/api/env/target/[targetId]/route.ts</files>
  <action>Wire GET/POST route handlers to `forge-env target-read/target-write` and propagate diagnostics, attempts, and remediation messages.</action>
  <verify>Route returns 400 for headless writes and includes actionable message payloads.</verify>
  <done>RepoStudio API mirrors forge-env target service contract.</done>
</task>

<task type="auto">
  <name>Add regression tests for mode mapping and headless block</name>
  <files>packages/forge-env/src/__tests__/target-service.test.mjs; packages/forge-env/src/commands/doctor.mjs</files>
  <action>Cover target snapshots, per-mode file writes, and deterministic headless write rejection.</action>
  <verify>`pnpm --filter @forge/forge-env test` passes with new target-service coverage.</verify>
  <done>Phase 05 env API contract is guarded by tests.</done>
</task>
</tasks>
