---
phase: 04-story-domain-codex-writer
plan: 02
wave: 2
depends_on:
  - '04-01'
files_modified:
  - apps/repo-studio/src/lib/scope-guard.ts
  - apps/repo-studio/src/lib/scope-overrides.ts
  - apps/repo-studio/app/api/repo/scope-overrides/start/route.ts
  - apps/repo-studio/app/api/repo/scope-overrides/stop/route.ts
  - apps/repo-studio/app/api/repo/scope-overrides/status/route.ts
  - apps/repo-studio/app/api/repo/codex/turn/start/route.ts
autonomous: true
must_haves:
  truths:
    - "Out-of-scope Codex operations are blocked by default under story hard scope policy."
    - "Scope override tokens are explicit, TTL-bound, and auditable."
  artifacts:
    - path: ".planning/phases/04-story-domain-codex-writer/04-02-SUMMARY.md"
      provides: "Scope guard + override lifecycle execution summary."
      min_lines: 10
  key_links:
    - from: ".planning/ROADMAP.md"
      to: ".planning/phases/04-story-domain-codex-writer/04-02-SUMMARY.md"
      via: "phase-to-summary traceability"
---

<objective>
Enforce story-domain scope policy for Codex turns, file APIs, and proposal approvals with explicit override token controls.
</objective>

<context>
@apps/repo-studio/src/lib/scope-guard.ts
@apps/repo-studio/src/lib/scope-overrides.ts
@apps/repo-studio/app/api/repo/scope-overrides
@apps/repo-studio/app/api/repo/codex
</context>

<tasks>
<task type="auto">
  <name>Harden scope override lifecycle</name>
  <files>apps/repo-studio/src/lib/scope-overrides.ts, apps/repo-studio/app/api/repo/scope-overrides/*</files>
  <action>Ensure token creation, expiry pruning, and stop behavior are deterministic and safe.</action>
  <verify>Status endpoint reports active/expired entries with clear messages.</verify>
  <done>Operators can temporarily widen scope intentionally without silent escalation.</done>
</task>

<task type="auto">
  <name>Apply scope guard to codex and proposal paths</name>
  <files>apps/repo-studio/src/lib/scope-guard.ts, apps/repo-studio/app/api/repo/codex/*, apps/repo-studio/app/api/repo/proposals/*</files>
  <action>Block out-of-scope turn/apply flows and return actionable remediation payloads.</action>
  <verify>Out-of-scope requests fail deterministically with operation + roots + blocked path context.</verify>
  <done>Codex edits remain domain-safe by default.</done>
</task>
</tasks>
