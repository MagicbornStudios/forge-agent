# Plan 19-04: Assistant runtime unification and data stream alignment

## Goal

Unify Forge and Codex assistant paths so both expose tools and behave consistently from the UI perspective. Align on a single, definitive way to use AI in our system—either via assistant-ui's Data Stream protocol or a custom runtime that maps both backends to the same interface. Reduce divergence between runtimes while respecting their distinct backends (Open Router vs Codex app-server).

## Context

- **Forge:** AI SDK transport (`AssistantChatTransport`), body.tools → streamText, tools execute via `makeAssistantTool`.
- **Codex:** JSON-RPC to Codex app-server, streams `text-delta`, `approval-request`, `event`; no tool support today; route ignores `event` type.
- **Divergence:** Codex gets no contract/tools; tool execution paths differ; approval flows differ.
- **assistant-ui Data Stream:** [docs/runtimes/data-stream](https://www.assistant-ui.com/docs/runtimes/data-stream) — standardized format for streaming, tool calling, state, attachments. Backend returns `createAssistantStreamResponse`; frontend uses `useDataStreamRuntime`. *Note:* human-in-the-loop tools not supported in data stream runtime; use LocalRuntime or Assistant Cloud for approval workflows.

## Scope

### In scope

1. **Unified contract for both runtimes** — Pass same contract and toolsEnabled when Codex is selected (today only Forge gets it).
2. **Tool schema extraction** — Add `getToolSchemas()` or equivalent to contract; use for both Forge (body.tools) and Codex (turn/start params when supported).
3. **Codex tool bridge** — Handle `event.type === 'event'` in streamFromCodexTurn; when method is `tool/invoke` (or agreed Codex protocol), forward as `data-domain-tool-invoke` for client execution.
4. **Pass tools to Codex** — Extend startCodexTurn to accept tool schemas; pass when transport is app-server and tools are enabled.
5. **Domain-agnostic tool event** — Use `data-domain-tool-invoke` with `{ domain, name, args }` instead of forge-specific naming.
6. **Document runtime strategy** — Full design in [.planning/ASSISTANT-RUNTIME-STRATEGY.md](../../ASSISTANT-RUNTIME-STRATEGY.md).

### Out of scope (this plan)

- Migrating to `@assistant-ui/react-data-stream` and `createAssistantStreamResponse` (evaluate as follow-on).
- LangGraph integration (19-03).
- Codex product changes (we adapt to whatever Codex emits).

## Data Stream vs current approach

| Aspect | Current (AI SDK transport) | Data Stream protocol |
|--------|---------------------------|----------------------|
| Forge | Works; tools from body | Would need backend to emit data stream format |
| Codex | Custom stream mapping | Codex would need to emit data stream format OR we adapt |
| Tools | makeAssistantTool + AI SDK | frontendTools helper; backend processes tools |
| Approval | Codex approval-request custom | Data stream: human-in-the-loop not supported |
| Recommendation | Keep AI SDK for Forge; add Codex bridge | Consider data stream as *unified backend contract* longer-term |

**Decision:** Implement bridge in current architecture first (minimal change). Evaluate `useDataStreamRuntime` + backend `createAssistantStreamResponse` when we need a single backend contract for scale or multi-client support.

## Prerequisites

- Codex app-server must support either (a) tools in turn/start and tool-call events, or (b) custom notification `tool/invoke` we define. If Codex does not support either, this plan delivers client/route readiness; tool execution waits on Codex.

## Tasks

| ID | Task | Status |
|----|------|--------|
| FRG-1908 | Pass contract and toolsEnabled for Codex runtime (same as Forge) in AssistantPanel | Pending |
| FRG-1909 | Add getToolSchemas() or toolsToRequestSchema(contract) helper; use in Forge path and startCodexTurn | Pending |
| FRG-1910 | Handle event.type === 'event' in streamFromCodexTurn; forward tool/invoke as data-domain-tool-invoke | Pending |
| FRG-1911 | Add useToolInvocationListener or equivalent for Codex tool execution on client | Pending |
| FRG-1912 | Extend startCodexTurn to accept and pass tools param (when app-server + tools enabled) | Pending |
| FRG-1913 | Document ASSISTANT-RUNTIME-STRATEGY.md with full design, divergence points, and data stream evaluation | Pending |

## Done criteria

- Codex receives same contract as Forge when tools enabled.
- Route forwards Codex tool events to client when Codex emits them.
- Client can execute domain tools for both runtimes via same contract.
- Document strategy and open questions (Codex protocol support, data stream migration).
- No regression to Forge path.

## References

- [assistant-ui Data Stream Protocol](https://www.assistant-ui.com/docs/runtimes/data-stream)
- [assistant-ui react-data-stream API](https://www.assistant-ui.com/docs/api-reference/integrations/react-data-stream)
- [.planning/ASSISTANT-RUNTIME-STRATEGY.md](../../ASSISTANT-RUNTIME-STRATEGY.md)
- Phase 19 context: [19-CONTEXT.md](19-CONTEXT.md)
