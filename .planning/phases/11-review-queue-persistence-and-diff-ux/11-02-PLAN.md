---
phase: 11-review-queue-persistence-and-diff-ux
plan: 02
wave: 2
depends_on:
  - 11-01
files_modified:
  - apps/repo-studio/src/lib/proposals/diff-parser.ts
  - apps/repo-studio/app/api/repo/proposals/diff-files/route.ts
  - apps/repo-studio/app/api/repo/proposals/diff-file/route.ts
  - apps/repo-studio/src/lib/api/types.ts
  - apps/repo-studio/src/lib/api/services/proposals.ts
  - apps/repo-studio/src/lib/api/services/index.ts
autonomous: true
must_haves:
  truths:
    - "Proposal diff APIs must return deterministic per-file entries for Review Queue UX."
    - "Component networking remains typed-service based (no direct fetch in workspaces)."
    - "Diff parser handles incomplete/no-patch payloads safely."
  artifacts:
    - path: ".planning/phases/11-review-queue-persistence-and-diff-ux/11-02-SUMMARY.md"
      provides: "Proposal diff parser and API contract implementation summary."
      min_lines: 10
  key_links:
    - from: ".planning/REQUIREMENTS.md"
      to: ".planning/phases/11-review-queue-persistence-and-diff-ux/11-02-SUMMARY.md"
      via: "REQ-25 diff UX API trace"
---

<objective>
Implement proposal diff parsing and typed API/client surfaces needed for one-file-at-a-time Review Queue patch review.
</objective>

<context>
@apps/repo-studio/src/lib/proposals/index.ts
@apps/repo-studio/src/lib/api/types.ts
@apps/repo-studio/src/lib/api/services/proposals.ts
</context>

<tasks>
<task type="auto">
  <name>Add proposal unified-diff parser</name>
  <files>apps/repo-studio/src/lib/proposals/diff-parser.ts</files>
  <action>Parse unified diff text into file entries (path/status/additions/deletions/hunks/patch text) with deterministic ordering.</action>
  <verify>Parser extracts file metadata and patch payloads for multi-file and single-file diffs.</verify>
  <done>Review Queue can inspect proposal changes file-by-file without raw full-diff-only rendering.</done>
</task>

<task type="auto">
  <name>Add proposal diff APIs</name>
  <files>apps/repo-studio/app/api/repo/proposals/diff-files/route.ts, apps/repo-studio/app/api/repo/proposals/diff-file/route.ts</files>
  <action>Expose `diff-files` and `diff-file` routes with stable response DTOs and proposal/path validation.</action>
  <verify>Routes return deterministic payloads for valid proposal IDs and actionable errors for unknown proposals/files.</verify>
  <done>Review Queue has server-side diff endpoints for file list and selected patch retrieval.</done>
</task>

<task type="auto">
  <name>Extend typed client contracts</name>
  <files>apps/repo-studio/src/lib/api/types.ts, apps/repo-studio/src/lib/api/services/proposals.ts</files>
  <action>Add proposal diff DTOs + service calls and keep all workspace calls typed-client based.</action>
  <verify>Type-check succeeds and Review Queue can consume diff APIs with no direct component fetch.</verify>
  <done>Diff API integration is type-safe and reusable across panels.</done>
</task>
</tasks>
